<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MLM Price + VP Cart</title>
  <style>
    body{font-family:Arial, sans-serif;margin:16px;}
    h1{margin:0 0 6px;}
    .muted{color:#666;font-size:12px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;box-shadow:0 1px 6px rgba(0,0,0,.04);}
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid #eee;padding:8px;vertical-align:top;}
    th{background:#fafafa;}
    input,select,button{padding:8px;border-radius:10px;border:1px solid #ccc;}
    button{cursor:pointer;background:#fff;}
    .btnPrimary{background:#111;color:#fff;border-color:#111;}
    .right{text-align:right;}
    .danger{color:#b00020;}
    .pill{display:inline-block;background:#f3f3f3;border-radius:999px;padding:3px 10px;font-size:12px;}
    .grid{display:grid;grid-template-columns:1fr 1.15fr;gap:12px;}
    @media(max-width:1000px){ .grid{grid-template-columns:1fr;} }
    .mini{font-size:11px;color:#666;}
    .invoiceArea{display:none;}
    @media print{
      body{margin:0;}
      .noPrint{display:none!important;}
      .invoiceArea{display:block;}
      .card{border:none;box-shadow:none;}
    }
  </style>
</head>
<body>
<!-- ✅ ADMIN BUTTON (RIGHT PLACE) -->
<div style="position:fixed; top:14px; right:14px; z-index:9999;">
  <a href="./admin.html"
     style="
       padding:8px 14px;
       background:#111;
       color:#fff;
       border-radius:999px;
       text-decoration:none;
       font-size:14px;
     ">
    Admin
  </a>
</div>
<!-- ✅ ADMIN BUTTON END -->

<h1>MLM Price + VP Cart</h1>

  <div class="noPrint">
    <h1>MLM Price + VP Cart</h1>
    <div class="muted">
      Slabs: <b>15% / 25% / 35% / 42% / 50%</b>
      • Default: fixed slab prices (Admin set) • Custom % = MRP se calculate
      • Admin: <span class="pill">admin.html</span>
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <!-- PRODUCTS -->
    <div class="card noPrint">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0;">Products</h3>
        <button id="reloadBtn">Reload</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="search" placeholder="Search product..." style="flex:1;min-width:240px;"/>
        <div class="mini">Products count: <span id="pCount">0</span></div>
      </div>

      <div style="margin-top:10px;max-height:520px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th class="right">MRP</th>
              <th class="right">VP</th>
              <th class="right"></th>
            </tr>
          </thead>
          <tbody id="productsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- CART -->
    <div class="card">
      <div class="row noPrint" style="justify-content:space-between;">
        <h3 style="margin:0;">Cart</h3>
        <div class="row">
          <button id="clearCart" class="danger">Clear</button>
          <button id="printBtn" class="btnPrimary">Invoice / Print</button>
        </div>
      </div>

      <div class="noPrint" style="margin-top:10px;max-height:520px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th class="right">Qty</th>
              <th>Slab</th>
              <th class="right">Custom %</th>
              <th class="right">Final</th>
              <th class="right">VP</th>
              <th class="right"></th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
      </div>

      <div class="card noPrint" style="margin-top:10px;background:#fafafa;">
        <div class="row">
          <div style="flex:1;min-width:220px;">
            <div><b>Total VP:</b> <span id="totalVP">0</span></div>
            <div><b>Subtotal:</b> ₹ <span id="subtotal">0</span></div>
            <div><b>Shipping:</b> ₹ <span id="shipOut">0</span></div>
            <div style="font-size:18px;"><b>Grand Total:</b> ₹ <span id="grandTotal">0</span></div>
          </div>

          <div style="flex:1;min-width:240px;">
            <div class="row">
              <div style="flex:1;">
                <div class="muted">Default Slab (new items)</div>
                <select id="defaultSlab" style="width:100%;">
                  <option value="15">15%</option>
                  <option value="25">25%</option>
                  <option value="35">35%</option>
                  <option value="42" selected>42%</option>
                  <option value="50">50%</option>
                </select>
              </div>
              <div style="flex:1;">
                <div class="muted">Manual Shipping</div>
                <input id="manualShipping" type="number" min="0" step="1" value="0" style="width:100%;"/>
              </div>
            </div>
            <div class="muted" style="margin-top:6px;">
              Shipping rule admin se aa sakta hai. Manual shipping agar bhar doge to override ho jayega.
            </div>
          </div>
        </div>
      </div>

      <!-- PRINT INVOICE AREA -->
      <div class="invoiceArea">
        <div style="padding:18px;">
          <h2 style="margin:0;">Invoice</h2>
          <div class="muted">Generated from MLM Price + VP Cart</div>
          <hr/>
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th class="right">Qty</th>
                <th class="right">Unit</th>
                <th class="right">Total</th>
                <th class="right">VP</th>
              </tr>
            </thead>
            <tbody id="printBody"></tbody>
          </table>
          <hr/>
          <div class="right">
            <div><b>Total VP:</b> <span id="p_vp">0</span></div>
            <div><b>Subtotal:</b> ₹ <span id="p_sub">0</span></div>
            <div><b>Shipping:</b> ₹ <span id="p_ship">0</span></div>
            <div style="font-size:18px;"><b>Grand Total:</b> ₹ <span id="p_grand">0</span></div>
          </div>
          <div class="muted" style="margin-top:14px;">
            *Slab prices admin list se aate hain. Custom % ho to MRP se calculate hota hai.
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ------------------ STORAGE ------------------ */
const KEY_PRODUCTS = "mlm_products_v2";
const KEY_CART     = "mlm_cart_v2";
const KEY_SETTINGS = "mlm_settings_v2";

const SLABS = [15,25,35,42,50];

const DEFAULT_PRODUCTS = [
  {
    id: crypto.randomUUID(),
    name: "Sample Product",
    vp: 10,
    mrp: 1000,
    slabPrices: {"15":850,"25":750,"35":650,"42":580,"50":500}
  }
];

const DEFAULT_SETTINGS = {
  shipping_mode: "flat",     // flat | free_above
  shipping_flat: 0,
  shipping_free_above: 0
};

function safeParse(s, fallback){ try{ return JSON.parse(s); }catch{ return fallback; } }
function num(x){ return Number(x)||0; }
function money(x){ return Math.round(num(x)); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function loadProducts(){
  const p = safeParse(localStorage.getItem(KEY_PRODUCTS), null);
  if(!Array.isArray(p) || p.length===0){
    localStorage.setItem(KEY_PRODUCTS, JSON.stringify(DEFAULT_PRODUCTS));
    return DEFAULT_PRODUCTS;
  }
  // ensure slabPrices exists
  p.forEach(x => { if(!x.slabPrices) x.slabPrices = {}; });
  return p;
}
function saveProducts(list){ localStorage.setItem(KEY_PRODUCTS, JSON.stringify(list)); }

function loadCart(){ return safeParse(localStorage.getItem(KEY_CART), []); }
function saveCart(c){ localStorage.setItem(KEY_CART, JSON.stringify(c)); }

function loadSettings(){
  const s = safeParse(localStorage.getItem(KEY_SETTINGS), null);
  if(!s){
    localStorage.setItem(KEY_SETTINGS, JSON.stringify(DEFAULT_SETTINGS));
    return DEFAULT_SETTINGS;
  }
  return {...DEFAULT_SETTINGS, ...s};
}

/* ------------------ PRICE LOGIC ------------------ */
function unitPrice(product, slabPct, customPct){
  // custom % -> MRP based
  if(customPct !== "" && customPct !== null && customPct !== undefined){
    const pct = clamp(num(customPct), 0, 95);
    return num(product.mrp) * (1 - pct/100);
  }
  // slab fixed price
  const sp = product.slabPrices?.[String(slabPct)];
  if(sp !== undefined && sp !== null && sp !== ""){
    return num(sp);
  }
  // fallback: % from MRP
  return num(product.mrp) * (1 - num(slabPct)/100);
}

function calcTotals(products, cart){
  let subtotal = 0;
  let totalVP = 0;

  for(const item of cart){
    const p = products.find(x => x.id === item.productId);
    if(!p) continue;

    const qty = Math.max(1, parseInt(item.qty||1, 10));
    const slabPct = num(item.slabPct) || 42;
    const u = unitPrice(p, slabPct, item.customPct);
    subtotal += u * qty;
    totalVP += num(p.vp) * qty;
  }

  const settings = loadSettings();
  const manualShip = num(document.getElementById("manualShipping").value);
  let shipping = 0;

  if(manualShip > 0){
    shipping = manualShip;
  }else{
    if(settings.shipping_mode === "free_above"){
      shipping = subtotal >= num(settings.shipping_free_above) ? 0 : num(settings.shipping_flat);
    }else{
      shipping = num(settings.shipping_flat);
    }
  }

  return { subtotal, totalVP, shipping, grand: subtotal + shipping };
}

/* ------------------ UI ------------------ */
let products = loadProducts();
let cart = loadCart();

const productsBody = document.getElementById("productsBody");
const cartBody = document.getElementById("cartBody");
const searchEl = document.getElementById("search");
const defaultSlabEl = document.getElementById("defaultSlab");

function renderProducts(){
  const q = (searchEl.value||"").toLowerCase().trim();
  const list = products.filter(p => p.name.toLowerCase().includes(q));

  document.getElementById("pCount").textContent = list.length;

  productsBody.innerHTML = "";
  for(const p of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${esc(p.name)}</b><div class="mini">Slab prices saved in admin</div></td>
      <td class="right">₹ ${money(p.mrp)}</td>
      <td class="right">${num(p.vp).toFixed(2)}</td>
      <td class="right"><button class="btnPrimary">Add</button></td>
    `;
    tr.querySelector("button").onclick = () => addToCart(p.id);
    productsBody.appendChild(tr);
  }
}

function slabOptions(selected){
  return SLABS.map(s => `<option value="${s}" ${num(selected)===s?"selected":""}>${s}%</option>`).join("");
}

function renderCart(){
  cartBody.innerHTML = "";

  for(let i=0;i<cart.length;i++){
    const item = cart[i];
    const p = products.find(x => x.id === item.productId);
    if(!p) continue;

    const qty = Math.max(1, parseInt(item.qty||1,10));
    const slabPct = num(item.slabPct)||42;
    const u = unitPrice(p, slabPct, item.customPct);
    const lineTotal = u * qty;
    const lineVP = num(p.vp) * qty;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <b>${esc(p.name)}</b>
        <div class="mini">MRP ₹${money(p.mrp)} | VP ${num(p.vp).toFixed(2)}</div>
        <div class="mini">Unit: ₹${money(u)} (slab/custom)</div>
      </td>
      <td class="right"><input type="number" min="1" step="1" value="${qty}" style="width:74px;"></td>
      <td><select>${slabOptions(slabPct)}</select></td>
      <td class="right"><input type="number" min="0" max="95" step="0.1" value="${item.customPct ?? ""}" placeholder="-" style="width:92px;"></td>
      <td class="right">₹ ${money(lineTotal)}</td>
      <td class="right">${lineVP.toFixed(2)}</td>
      <td class="right"><button class="danger">Remove</button></td>
    `;

    const qtyInp = tr.querySelectorAll("input")[0];
    const customInp = tr.querySelectorAll("input")[1];
    const slabSel = tr.querySelector("select");
    const rmBtn = tr.querySelector("button");

    qtyInp.oninput = () => {
      cart[i].qty = Math.max(1, parseInt(qtyInp.value||"1",10));
      saveCart(cart); renderCart(); renderTotals();
    };
    slabSel.onchange = () => {
      cart[i].slabPct = num(slabSel.value);
      saveCart(cart); renderCart(); renderTotals();
    };
    customInp.oninput = () => {
      const v = customInp.value;
      cart[i].customPct = (v==="" ? "" : num(v));
      saveCart(cart); renderCart(); renderTotals();
    };
    rmBtn.onclick = () => {
      cart.splice(i,1);
      saveCart(cart); renderCart(); renderTotals();
    };

    cartBody.appendChild(tr);
  }
}

function renderTotals(){
  const t = calcTotals(products, cart);
  document.getElementById("totalVP").textContent = t.totalVP.toFixed(2);
  document.getElementById("subtotal").textContent = money(t.subtotal);
  document.getElementById("shipOut").textContent = money(t.shipping);
  document.getElementById("grandTotal").textContent = money(t.grand);
  renderPrintInvoice(t);
}

function renderPrintInvoice(totals){
  const printBody = document.getElementById("printBody");
  printBody.innerHTML = "";

  for(const item of cart){
    const p = products.find(x => x.id === item.productId);
    if(!p) continue;

    const qty = Math.max(1, parseInt(item.qty||1,10));
    const slabPct = num(item.slabPct)||42;
    const u = unitPrice(p, slabPct, item.customPct);
    const lineTotal = u * qty;
    const lineVP = num(p.vp) * qty;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(p.name)}</td>
      <td class="right">${qty}</td>
      <td class="right">₹ ${money(u)}</td>
      <td class="right">₹ ${money(lineTotal)}</td>
      <td class="right">${lineVP.toFixed(2)}</td>
    `;
    printBody.appendChild(tr);
  }

  document.getElementById("p_vp").textContent = totals.totalVP.toFixed(2);
  document.getElementById("p_sub").textContent = money(totals.subtotal);
  document.getElementById("p_ship").textContent = money(totals.shipping);
  document.getElementById("p_grand").textContent = money(totals.grand);
}

/* ------------------ ACTIONS ------------------ */
function addToCart(productId){
  const existing = cart.find(x => x.productId === productId && (x.customPct==="" || x.customPct===null || x.customPct===undefined));
  if(existing){
    existing.qty = Math.max(1, parseInt(existing.qty||1,10)) + 1;
  }else{
    cart.push({
      productId,
      qty: 1,
      slabPct: num(defaultSlabEl.value)||42,
      customPct: "" // empty means slab price used
    });
  }
  saveCart(cart);
  renderCart(); renderTotals();
}

document.getElementById("reloadBtn").onclick = () => {
  products = loadProducts();
  renderProducts();
  renderCart();
  renderTotals();
};

document.getElementById("clearCart").onclick = () => {
  cart = [];
  saveCart(cart);
  renderCart();
  renderTotals();
};

document.getElementById("printBtn").onclick = () => window.print();

searchEl.oninput = renderProducts;
document.getElementById("manualShipping").oninput = renderTotals;

/* ------------------ INIT ------------------ */
products = loadProducts();
cart = loadCart();
renderProducts();
renderCart();
renderTotals();
</script>
</body>
</html>
